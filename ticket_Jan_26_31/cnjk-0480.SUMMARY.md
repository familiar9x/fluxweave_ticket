# cnjk-0480: SPIPF009K00R02 Migration Summary

## Ticket Information
- **Ticket ID**: cnjk-0480
- **Procedure**: SPIPF009K00R02
- **Description**: 部店マスタ更新結果リスト (Branch Master Update Result List)
- **Status**: ✅ COMPLETED

## Migration Steps Completed

### 1. Initial Setup
- Copied generated file from branch T0009
- Ran `convert_pkprint_calls.py` - converted 5 pkPrint.insertData calls
- Ran `script_convert_simple.sh` for data type fixes

### 2. Major Issues Fixed

#### Oracle Associative Array → PostgreSQL Array
Same pattern as spjd-0914:
- Line 48: Commented out `TYPE NUMARRAY IS TABLE OF numeric INDEX BY integer`
- Line 69: Changed `gAryCnt NUMARRAY` → `gAryCnt numeric[]`
- Line 182: Added initialization `gAryCnt := ARRAY[0, 0, 0]`
- Converted all array references from 0-based to 1-based indexing
  - `gAryCnt(0)` → `gAryCnt[1]` (正常件数)
  - `gAryCnt(1)` → `gAryCnt[2]` (エラー件数)

#### cursor%ROWTYPE → RECORD
- Lines 119-120: Changed to `recPrevMeisai RECORD; recWorkMeisai RECORD;`
- Added temp variables: `wkBankRnm varchar; wkErrUmuFlg varchar;`

#### PostgreSQL RECORD Read-Only Limitation
Same critical fix as spjd-0914:
- Commented out RECORD field modifications (lines 189-191)
- Added conditional BANK_RNM logic based on JIKO_DAIKO_KBN
- Applied at lines: 204-221, 257-264, 305-322, 351-368, 394-411

#### OUT Parameter Type
- Line 10: Changed `l_outSqlCode OUT numeric` → `l_outSqlCode OUT integer`

#### First Iteration Guard
- Line 199: Added `AND gRecCnt > 0` to prevent accessing uninitialized recPrevMeisai

#### Bug Fix in Total Count Logic
- Line 394: Fixed duplicate condition `gAryCnt[2] = 0 AND gAryCnt[2] = 0`
- Changed to: `gAryCnt[1] = 0 AND gAryCnt[2] = 0` (check both normal and error counts)

### 3. Test Data
```sql
INSERT INTO butenkoshin_list_wk (
    itaku_kaisha_cd, seq_no, tekiyost_ymd, yoyaku_kbn, buten_cd,
    buten_nm, buten_rnm, group_cd, post_no, add1, add2, add3,
    busho_nm, tel_no, fax_no, mail_add, data_recv_ymd,
    err_umu_flg, err_cd_6, err_nm_30
) VALUES (
    '0005', 1, '20251104', '1', '001',
    'Test Branch', 'TBR', '001', '1000001', 'Tokyo', 'Chiyoda', '',
    'Sales', '03-1234-5678', '03-1234-5679', 'test@example.com', '20251104',
    '0', '', ''
);
```

### 4. Execution Results
```bash
CALL spipf009k00r02('0005', 'BATCH', '1', '20251104', NULL, NULL);
# Result: l_outsqlcode = 0 ✅
```

## Key Migration Patterns Applied

Same patterns as spjd-0914:
1. PostgreSQL RECORD from cursor is read-only
2. Cannot modify individual fields → check conditions when using values
3. Array indexing: Oracle 0-based → PostgreSQL 1-based
4. First iteration guard: `AND gRecCnt > 0`
5. JIKO_DAIKO_KBN = '2' check for BANK_RNM usage

## Files Modified
- `/home/ansible/fluxweave_ticket/cnjk-0480.SPIPF009K00R02.sql` (450 lines)

## Dependencies
- Procedure: `pkPrint.insertData` (composite type)
- Procedure: `pkPrint.insertHeader`
- Function: `pkDate.getGyomuYmd`
- Tables: `butenkoshin_list_wk`, `vjiko_itaku`, `scode`, `sreport_wk`

## Related Tickets
- **wzbg-9900** (SFIPF009K00R09) - Wrapper function that calls this procedure ✅

## Migration Date
- January 22, 2026
