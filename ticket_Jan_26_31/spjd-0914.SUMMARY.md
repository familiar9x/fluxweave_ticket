# spjd-0914: SPIPF009K00R01 Migration Summary

## Ticket Information
- **Ticket ID**: spjd-0914
- **Procedure**: SPIPF009K00R01
- **Description**: 口座情報更新結果リスト (Account Information Update Result List)
- **Status**: ✅ COMPLETED

## Migration Steps Completed

### 1. Initial Setup
- Copied generated file to `/home/ansible/fluxweave_ticket/spjd-0914.SPIPF009K00R01.sql`
- Ran `convert_pkprint_calls.py` - converted 5 pkPrint.insertData calls
- Ran `script_convert_simple.sh` for data type fixes

### 2. Major Issues Fixed

#### Oracle Associative Array → PostgreSQL Array
- **Issue**: `TYPE NUMARRAY IS TABLE OF numeric INDEX BY integer` not supported
- **Solution**: Converted to `numeric[]` with 1-based indexing
- Changes:
  - Line 48: Commented out Oracle TYPE definition
  - Line 66: Changed `gAryCnt NUMARRAY` → `gAryCnt numeric[]`
  - Line 202: Added initialization `gAryCnt := ARRAY[0, 0, 0]`
  - Lines 203-204: Changed array indexing from 0-based to 1-based
  - Line 214: Changed `gAryCnt(recMeisai.ERR_UMU_FLG)` → `gAryCnt[recMeisai.ERR_UMU_FLG::integer + 1]`

#### cursor%ROWTYPE → RECORD
- **Issue**: PostgreSQL doesn't support `%ROWTYPE` on cursor variables
- **Solution**: Changed to RECORD type
- Lines 128-129: `recPrevMeisai RECORD; recWorkMeisai RECORD;`

#### PostgreSQL RECORD Read-Only Limitation (Critical Fix)
- **Issue**: Oracle code tried to modify RECORD field: `recMeisai.BANK_RNM := NULL`
- **PostgreSQL Limitation**: Cannot modify individual fields of RECORD type from cursor
- **Solution**: 
  1. Commented out field modification (line 210-212)
  2. Added temp variables: `wkBankRnm varchar; wkErrUmuFlg varchar` (lines 130-131)
  3. Check `JIKO_DAIKO_KBN = '2'` condition when **using** BANK_RNM instead of modifying it
  4. Applied conditional logic at lines: 222-239, 276-281, 330-339, 368-378, 401-419

#### STRICT SELECT with Multiple Rows
- **Issue**: Line 186 `SELECT bank_rnm INTO STRICT` can return multiple rows
- **Solution**: Added `LIMIT 1` to get first row only

#### First Iteration Bug
- **Issue**: `gErrUmuFlg = '1'` initially, first record has ERR_UMU_FLG='0', triggered break logic before recPrevMeisai assigned
- **Solution**: Line 218 - Added condition `AND gRecCnt > 0` to skip break on first record

#### Missing Tables
- Created `kozajyohokoshin_list_wk` table from DDL
- Created `butenkoshin_list_wk` table from DDL

### 3. Test Data
```sql
INSERT INTO kozajyohokoshin_list_wk (
    itaku_kaisha_cd, chohyo_id, tekiyost_ymd, old_koza_ten_cd,
    old_koza_ten_cifcd, old_koza_kamoku, old_koza_no,
    new_koza_ten_cd, new_koza_ten_cifcd, new_koza_kamoku, new_koza_no,
    hkt_cd, koza_shubetu, filter_shubetu, data_recv_ymd,
    err_umu_flg, seq_no
) VALUES (
    '0005', 'IPF30000921', '20251104', '001',
    'CIF001', '01', '1234567',
    '002', 'CIF002', '01', '7654321',
    'HKT001', '1', '1', '20251104',
    '0', 1
);
```

### 4. Execution Results
```bash
# Test spjd-0914
CALL spipf009k00r01('IPF30000921', '0005', 'BATCH', '1', '20251104', NULL, NULL);
# Result: l_outsqlcode = 0 ✅
```

## Key PostgreSQL Migration Patterns Learned

### Pattern 1: RECORD Type is Read-Only
```sql
-- ❌ Oracle: Modify cursor record field
FOR rec IN cursor LOOP
    rec.field := value;  -- NOT ALLOWED in PostgreSQL
END LOOP;

-- ✅ PostgreSQL: Check condition when using value
FOR rec IN cursor LOOP
    IF rec.condition = '2' THEN
        output := rec.field;
    ELSE
        output := NULL;
    END IF;
END LOOP;
```

### Pattern 2: Array Migration with Proper Indexing
```sql
-- Oracle: 0-based
array(0) := value;
array(1) := value;

-- PostgreSQL: 1-based
array[1] := value;
array[2] := value;
```

### Pattern 3: First Iteration Guard
```sql
IF gFlag != recCurrent.flag AND gRecCount > 0 THEN
    -- Use previous record safely (not on first iteration)
    process(recPrevious);
END IF;
```

## Files Modified
- `/home/ansible/fluxweave_ticket/spjd-0914.SPIPF009K00R01.sql` (429 lines)

## Dependencies
- Procedure: `pkPrint.insertData` (composite type)
- Procedure: `pkPrint.insertHeader`
- Function: `pkDate.getGyomuYmd`
- Tables: `kozajyohokoshin_list_wk`, `butenkoshin_list_wk`, `vjiko_itaku`, `mbuten`, `scode`, `mhakkotai`, `sreport_wk`

## Related Tickets
- **kszg-8324** (SFIPF009K00R08) - Wrapper function that calls this procedure ✅

## Migration Date
- January 22, 2026
