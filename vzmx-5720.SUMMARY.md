# Ticket vzmx-5720: SFIPF009K00R05 Migration Summary

## Status: REQUIRES MANUAL COMPLETION

## Issue
This function has nested sub-functions (COMMON_FUNC and EXIST_HKT_CD) that were extracted to separate functions by the auto-generator. However, these helper functions reference outer function variables which PostgreSQL doesn't support.

## What Was Done
1. ✅ Copied generated file from `/home/ansible/jip-ipa/generated/db_output_sql/branch/T0009/db/plsql/customize/smbc/batch/tencif/SFIPF009K00R05.sql`
2. ✅ Ran convert_pkprint_calls.py
3. ✅ Ran script_convert_simple.sh  
4. ✅ Fixed %type references for non-existent tables (replaced with TEXT)
5. ✅ Main function `sfipf009k00r05` compiles successfully
6. ❌ Helper functions `sfipf009k00r05_common_func` and `sfipf009k00r05_exist_hkt_cd` have compilation errors

## Remaining Issues

### Helper Function Variables
The helper functions reference these outer function variables:
- `nMax_Seq` - INOUT needed
- `cSeq_flg` - INOUT needed
- `cHkt_cd` - IN parameter
- `cKoza_shubetsu` - IN parameter
- `cRcv_dt` - IN parameter
- `cErr_flg` - IN parameter
- `cErr_cd` - IN parameter
- `vMsg` - IN parameter
- `vLmsg` - IN parameter
- `vTmsg` - IN parameter
- `nRet` - local variable in helper
- `nCount` - local variable in helper
- `nCount2` - local variable in helper

### Solutions

**Option 1: Add INOUT Parameters** (Recommended)
Convert helper functions to accept all outer variables as INOUT/IN parameters and return RECORD type. Update all call sites to pass/receive these values.

**Option 2: Inline Helper Functions** 
Copy the helper function logic directly into the main function at each call site. This is simpler but makes the main function very long (~1500+ lines).

**Option 3: Use Temporary Tables**
Store state in temporary tables that both main and helper functions can access. More complex but avoids parameter passing.

## Next Steps
1. Choose refactoring approach (recommend Option 1)
2. Add all needed parameters to `sfipf009k00r05_common_func`:
   - Add: `INOUT nMax_Seq NUMERIC, INOUT cSeq_flg CHAR(1)`
   - Add: `IN cHkt_cd TEXT, IN cKoza_shubetsu CHAR(1), IN cRcv_dt CHAR(8)`
   - Add: `IN cErr_flg CHAR(1), IN cErr_cd TEXT, IN vMsg TEXT, IN vLmsg TEXT, IN vTmsg TEXT`
   - Change return type from `INTEGER` to `RECORD`
   - Return: `(return_code, nMax_Seq, cSeq_flg)`

3. Add all needed parameters to `sfipf009k00r05_exist_hkt_cd`:
   - Add: `INOUT cErr_flg CHAR(1), INOUT cErr_cd TEXT, INOUT cKoza_shubetsu CHAR(1)`
   - Add: `INOUT vMsg TEXT, INOUT vLmsg TEXT, INOUT vTmsg TEXT`
   - Add: `IN cHkt_cd TEXT, IN nMax_Seq NUMERIC, IN cSeq_flg CHAR(1), IN cRcv_dt CHAR(8)`  
   - Change return type from `INTEGER` to `RECORD`

4. Update all 8 call sites in main function to:
   ```sql
   SELECT * INTO nRetf, nMax_Seq, cSeq_flg 
   FROM sfipf009k00r05_common_func(..., nMax_Seq, cSeq_flg, ...);
   ```

5. Fix missing table definitions:
   - `tencif_yoyaku` - needs DDL
   - May need test data for validation

## File Location
- Legacy: `/home/ansible/jip-ipa/legacy/branches_20250707/T0009/db/plsql/customize/smbc/batch/tencif/SFIPF009K00R05.sql`
- Generated: `/home/ansible/jip-ipa/generated/db_output_sql/branch/T0009/db/plsql/customize/smbc/batch/tencif/SFIPF009K00R05.sql`
- Working: `/home/ansible/fluxweave_ticket/vzmx-5720.SFIPF009K00R05.sql`
- Target: `branches/T0009/db/plsql/customize/smbc/batch/tencif/SFIPF009K00R05.sql`

## Complexity
This is a complex 800+ line function with multiple nested cursors and helper functions. Estimated additional effort: 2-3 hours for proper refactoring and testing.
