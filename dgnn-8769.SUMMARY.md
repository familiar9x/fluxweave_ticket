# dgnn-8769: SFADI002R04111 Migration Summary

## Status: ✅ COMPLETED

## Files Migrated
- **SFADI002R04111.sql** - Bond redemption information comparison (銘柄_償還回次テーブルとの突合処理)

## Migration Details

### Main Function: SFADI002R04111
- **Purpose**: Compare bond redemption information between KK_RENKEI (JASDEC data) and MGR_SHOKIJ (master table)
- **Parameters**: 
  - l_inKkSakuseiDt (KK_SAKUSEI_DT)
  - l_inDenbunMeisaiNo (DENBUN_MEISAI_NO)
  - l_inItakuKaishaCd (ITAKU_KAISHA_CD)
  - l_inMgrCd (MGR_CD)
  - l_inKbn (1-6: 銘柄情報, 利払情報, 償還情報コールオプション全額, 定時償還, コールオプション一部, プットオプション)
  - l_inItakuKaishaRnm (ITAKU_KAISHA_RNM)
- **Return Codes**: 0=SUCCESS, 40=NO_DATA_FIND, 50=RECONCILE_ERROR, 99=FATAL

### Helper Procedures
1. **SFADI002R04111_defineColumn**: Define DBMS_SQL columns for dynamic cursor
2. **SFADI002R04111_getColumnValue**: Retrieve DBMS_SQL column values

## Key Fixes Applied

### 1. DBMS_SQL Syntax
- ✅ Fixed `DBMS_SQL.OPEN_CURSOR()` - added missing parentheses
- ✅ Cast all numeric positions to `::int` in DEFINE_COLUMN and COLUMN_VALUE calls

### 2. INOUT Parameter Pattern
Implemented temp variable pattern for array elements (PostgreSQL restriction):
```sql
DECLARE
    tempMoto varchar(400);
    tempSaki varchar(400);
BEGIN
    FOR i IN 1 .. gOutItemCnt LOOP
        tempMoto := '';
        tempSaki := '';
        CALL DBMS_SQL.COLUMN_VALUE(curComp, (i * 2 -1)::int, tempMoto);
        CALL DBMS_SQL.COLUMN_VALUE(curComp, (i * 2)::int, tempSaki);
        tMoto[i] := tempMoto;
        tSaki[i] := tempSaki;
    END LOOP;
END;
```

### 3. pkCompare Infrastructure Enhancement
**Critical Fix**: Updated pkCompare.getCompareInfo to automatically handle numeric comparisons

**Problem**: 
- MOTO_ITEM: `decode(trim(RT02.ITEM027), null, null, to_number(RT02.ITEM027))` → converts to numeric
- SAKI_ITEM: `MG3.FACTOR` → numeric column
- When fetched into varchar(400) arrays and compared as text: `'0.9' != '0.9000000000'` → RECONCILE_ERROR

**Solution**: Enhanced pkCompare to auto-wrap numeric expressions with `pkcharacter.numeric_to_char()`:
```sql
-- Auto-detect numeric expressions (::numeric or numeric column names)
-- Wrap with numeric_to_char() for consistent text comparison
moto_converted: pkcharacter.numeric_to_char(CASE WHEN trim(RT02.ITEM027) IS NULL THEN NULL ELSE (RT02.ITEM027)::numeric END)
saki_converted: pkcharacter.numeric_to_char(MG3.FACTOR)
```

**Benefits**:
- Master data remains in Oracle format
- All comparison functions benefit automatically
- Follows principle: "Fix code, not data"

## Test Data

### KK_RENKEI (Source)
```sql
KK_SAKUSEI_DT: '20260112000002'
DENBUN_MEISAI_NO: 1
ITEM004: 'JP90B0006TP8' (ISIN_CD)
ITEM025: '20060930' (SHOKAN_KJT)
ITEM027: '0.9' (FACTOR)
```

### MGR_SHOKIJ (Destination)
```sql
ITAKU_KAISHA_CD: '0005'
MGR_CD: 'S620060331876'
SHOKAN_KJT: '20060930'
SHOKAN_KBN: '20'
FACTOR: 0.9000000000
```

## Testing

### Test Case Added
- **Location**: `/home/ansible/fluxweave_ticket/common/1_test_migration.py`
- **Test ID**: `dgnn-8769`
- **Expected Result**: 0 (SUCCESS)
- **Actual Result**: ✅ 0 (PASS)

### Test Command
```bash
python3 /home/ansible/fluxweave_ticket/common/1_test_migration.py dgnn-8769
```

## Deployment

### Files Deployed
1. **pkCompare.sql** (Infrastructure)
   - Location: `/home/ansible/jip-ipa/db/plsql/ipa/jasdecReceiveDenbun/pkCompare.sql`
   - Enhancement: Auto-wrap numeric expressions with numeric_to_char()

2. **SFADI002R04111.sql** (Main function)
   - Location: `/home/ansible/jip-ipa/db/plsql/ipa/jasdecReceiveDenbun/SFADI002R04111.sql`
   - All DBMS_SQL fixes applied
   - Temp variable pattern for INOUT parameters
   - Debug statements removed

### Deployment Commands
```bash
cd /home/ansible/jip-ipa/db/plsql/ipa/jasdecReceiveDenbun

# Deploy pkCompare
PGPASSWORD='***' psql -h jip-cp-ipa-postgre17.cvmszg1k9xhh.us-east-1.rds.amazonaws.com \
  -p 5432 -U rh_mufg_ipa -d rh_mufg_ipa -f pkCompare.sql

# Deploy SFADI002R04111
PGPASSWORD='***' psql -h jip-cp-ipa-postgre17.cvmszg1k9xhh.us-east-1.rds.amazonaws.com \
  -p 5432 -U rh_mufg_ipa -d rh_mufg_ipa -f SFADI002R04111.sql
```

## Related Tickets

This migration built upon patterns established in:
- **hnxj-6293** (SFADI002R28111): First comparison function with pkCompare
- **sdkz-2067** (SFADI005R08112): Established SELECT INTO pattern and temp variable approach
- **gwhf-9960** (pkCompare): Core infrastructure package

## Notes

### MOTO vs SAKI
- **MOTO (元)** = Source data from KK_RENKEI (JASDEC)
- **SAKI (先)** = Destination data from master tables (IPA)
- Pattern used consistently across all comparison functions

### Comparison Logic (TOTSUGO_NO: R04114)
- **Master Data**: Stored in SCOMPARING_ITEM table in Oracle format
- **Runtime Conversion**: pkCompare.getCompareInfo converts to PostgreSQL with automatic numeric handling
- **Return Codes**: 0=match, 50=mismatch, 40=no data, 99=fatal

## Migration Date
January 12, 2026
