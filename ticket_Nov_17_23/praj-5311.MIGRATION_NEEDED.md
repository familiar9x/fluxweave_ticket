# PRAJ-5311 SPIPW010K00R02 - Migration Status

## Current Issue
The procedure uses **OLD STYLE** pkPrint.insertData calls with individual parameters:
```sql
CALL pkPrint.insertData(
    l_inKeyCd => ...,
    l_inUserId => ...,
    l_inItem001 => value1,
    l_inItem002 => value2,
    ...
    l_inItem018 => value18,
    l_inKousinId => ...,
    l_inSakuseiId => ...
);
```

But the database now requires **NEW STYLE** with composite type:
```sql
-- Signature: pkPrint.insertData(
--   l_inKeyCd character varying,
--   l_inUserId character varying,
--   l_inChohyoKbn character varying,
--   l_inSakuseiYmd character varying,
--   l_inChohyoId character varying,
--   l_inSeqNo integer,
--   l_inHeaderFlg integer,
--   l_inItem type_sreport_wk_item,  -- <-- COMPOSITE TYPE
--   l_inKousinId character varying,
--   l_inSakuseiId character varying
-- )
```

## Migration Required

### 1. Add v_item declaration in DECLARE section:
```sql
DECLARE
    ...
    -- Item composite type for pkPrint.insertData
    v_item type_sreport_wk_item;
```

### 2. Before each insertData call, initialize and populate v_item:
```sql
-- Initialize composite type (all fields to NULL)
v_item := ROW(
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
    ... (200 NULLs total for item001-item200)
)::type_sreport_wk_item;

-- Set only the fields you need
v_item.l_inItem001 := l_inGyomuYmd;
v_item.l_inItem002 := gBankRnm;
v_item.l_inItem003 := l_inGyomuYmd;
v_item.l_inItem004 := gKozaSakuseiYmd;
v_item.l_inItem006 := '不一致';
v_item.l_inItem007 := pkcharacter.numeric_to_char(gNoMatchCnt);
... etc
```

### 3. Replace insertData call:
```sql
CALL pkPrint.insertData(
    l_inKeyCd      => l_inItakuKaishaCd,
    l_inUserId     => l_inUserId,
    l_inChohyoKbn  => l_inChohyoKbn,
    l_inSakuseiYmd => l_inGyomuYmd,
    l_inChohyoId   => C_REPORT_ID,
    l_inSeqNo      => gSeqNo,
    l_inHeaderFlg  => 1,
    l_inItem       => v_item,  -- <-- Use composite type
    l_inKousinId   => l_inUserId,
    l_inSakuseiId  => l_inUserId
);
```

## InsertData Calls to Migrate

The file has multiple pkPrint.insertData calls that need conversion:
1. Line ~328: First IPA side data insert (1 field: item001)
2. Line ~461: NODATA header (7 fields: item001-004, 006-007, 016-018)
3. Line ~482: Mismatch detail loop (11 fields: item001-004, 008-018)
4. Line ~510: Empty row (7 fields: item001-004, 016-018)
5. Line ~524: Match count header (7 fields: item001-007, 016-018)
6. Line ~541: Match detail loop (11 fields: item001-004, 008-018)

## Example Reference
See `/home/ec2-user/jip-ipa/db/plsql/ipa/option/chikoutai/SPIPH003K00R01.sql` for working NEW STYLE examples.

## Test Data
- ITAKU_KAISHA_CD: '0005' (has VJIKO_ITAKU record)
- USER_ID: 'TESTUSER'
- CHOHYO_KBN: '1'
- GYOMU_YMD: '20240401'
- KK_SAKUSEI_DT: '20991231235959000001' (test record in KK_RENKEI)

## Next Steps
1. Migrate all 6 insertData calls to composite type pattern
2. Deploy to database
3. Test with above test data - should return code 0 or 2 (no data)
4. Add to db/make_plsql.sql
